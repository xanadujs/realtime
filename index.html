<html>
<head>
  <title>Realtime</title>
  <script type="text/javascript" src="dreem/lib/jquery-1.9.1.js"></script>
  <script type="text/javascript" src="dreem/lib/acorn.js"></script>
  <script type="text/javascript" src="dreem/lib/coffee-script.js"></script>
  <script type="text/javascript" src="dreem/layout.js"></script>
  <style type="text/css">
    body {
      background-color: rgb(0,0,0);
      /*background-size: 259px 259px;
      font-family: 'Helvetica';
      font-size: 14px;*/
    }
    .sprite-inputtext {
        color: #f0f0f0;
    }
  </style>
</head>
<body>
<view id="canvas" width="95%" height="95%" padding="10">
    <class name="dblclicktext" extends="text">
        <attribute name="clickcount" value="0" type="number"></attribute>
        <handler event="ondblclick"></handler>
        <handler event="onclick">
            this.clickcount++;
            if (this.clickcount === 2) {
                this.clickcount = 0;
                this.sendEvent("dblclick");
            }
            var me = this;
            setTimeout(function(){
                me.clickcount = 0;
            }, 300)
        </handler>

    </class>
    <class name="groupdetailpanel" height="30" width="400" color="#d0d0d0"
        border="1" border-radius="3px" bgcolor="#202020" padding="5">
        <!-- <attribute name="title" type="string" value="title"/> -->
        <handler event="ondblclickitem" args="itemview"></handler>
        <text text="${this.parent.title}" y="-5"></text>
        <labelbutton text="x" y="-5" height="16" defaultcolor="null" selectcolor="null" color="#d0d0d0" x="${this.parent.width-this.width-15}">
            <handler event="onclick">
                this.parent.hide();
            </handler>
        </labelbutton>

        <view name="header">
            
        </view>

        <view name="list" y="16" height="${this.parent.height-26}" width="100%" scrollable="true">
            <view name="items">
                <replicator name="repl" classname="stockitem" pooling="true" lazycount="20"  
                    sortfield="netamountratio" sortasc="false"></replicator>
                <spacedlayout axis="y" spacing="0" updateparent="true"></spacedlayout>
            </view>
        </view>

        <handler event="oninit">
            //this.setAttribute("color", this.parent.parent.bordercolor);
        </handler>

        <method name="hide">
            this.list.items.repl.setAttribute("data", []);
            this.setAttribute("layouthint", null);
            this.setAttribute("height", 30);
        </method>

        <method name="show" args="data, options">
            this.setAttribute("layouthint", '{"weight":1}');
            this.options = options;
            for (var i=0; data.items.length>i; i++) {
                var obj = data.items[i];
                 var netfamt = obj.r0_in+obj.r1_in-obj.r0_out-obj.r1_out;
                 var famt = obj.r0+obj.r1+obj.r2+obj.r3;
                 obj.netamountratio = Math.abs(netfamt)/famt;
            }

            this.list.items.repl.setAttribute("data", data.items);
            //this.setAttribute("visible", true)
        </method>

    </class>
    <class name="stockitem" height="16"
        font-size="12" color="#d0d0d0">
        <handler event="ondata" args="data">
            //console.log("stockItem ondata", this);
            this.symbol.setAttribute("text", data.symbol);
            this.sname.setAttribute("text", data.name);
            this.trade.setAttribute("text", Number(data.trade).toFixed(2))

            var inc = data.price_inc*100;
            this.inc.setAttribute("color", inc>0?'#ff0000':'#00ff00');
            this.inc.setAttribute("text", Number(inc).toFixed(1)+"%")

            this.realtimeflow.setAttribute("text", Number(data.realtime_flow/10000).toFixed(0))
            if(!data.realtime_flow) this.realtimeflow.setAttribute("opacity", 0.2);

            var netfamt = data.r0_in+data.r1_in-data.r0_out-data.r1_out;
            this.netflowamount.setAttribute("text", Number(netfamt/10000).toFixed(0))

            var famt = data.r0+data.r1+data.r2+data.r3;
            this.flowamount.setAttribute("text", Number(100*Math.abs(netfamt)/famt).toFixed(0)+"%")

            this.ticktime.setAttribute("text", data.ticktime);
            var mcap = (data.volume*data.trade/(data.turnover/10000))/100000000;
            this.mcap.setAttribute("text", mcap.toFixed(0));
           // this.setAttribute("bgcolor", data.flow==="in"? '#ffdddd': '#ddffdd');
        </handler>
        <spacedlayout axis="x" spacing="5" updateparent="true"></spacedlayout>

        <dblclicktext name="symbol" width="50" resize="false">
            <handler event="ondblclick">
                this.parent.parent.parent.ondblclickitem(this.parent);
            </handler>  
        </dblclicktext>
        <text name="sname" width="50" resize="false"></text>
        <text name="trade" width="30" resize="false"  style="text-align:right"></text>
        <text name="inc" width="35" resize="false" style="text-align:right"></text>
        
        <text name="realtimeflow" width="30" resize="false"  style="text-align:right"></text>
        <text name="netflowamount" width="35" resize="false"  style="text-align:right"></text>
        <text name="flowamount" width="20" resize="false"  style="text-align:right"></text>
        <text name="mcap" width="35" resize="false"  style="text-align:right"></text>
        <text name="ticktime" width="100" resize="false"></text>
    </class>
    <activelist name="strongin" detailpanel="${this.parent.indetailpanelsleft.strongdetailpanel}"
        flow="in" bordercolor="#f0f0f0" width="200" height="50" ignorelayout="true">    
        <method name="appendData" args="data">
            if (data.length===0)  return;

            var flowamount = 0;
            var flow = this.flow;
            for (var i=0; data.length>i; i++) {
                flowamount += (data[i].r0_in+data[i].r1_in-data[i].r0_out-data[i].r1_out);
                this.latesttimeinstack = Math.max(this.latesttimeinstack, data[i].servertime)
            }
            
            data.sort(function(obj1, obj2) {
                var flowamount1 = obj1.r0_in+obj1.r1_in-obj1.r0_out-obj1.r1_out;
                var flowamount2 = obj2.r0_in+obj2.r1_in-obj2.r0_out-obj2.r1_out;

                if (flowamount1>flowamount2) return -1;
                else if (flowamount2>flowamount1) return 1;
                else return 0;
            });

            var pdata = this.groups.list.repl.data;
            var group = {items: data, flowamount: flowamount, time: this.latesttimeinstack, open:true};
            //pdata.push(group);
            this.groups.list.repl.setAttribute("data", [group])
            //this.list.repl.refresh();
        </method>

        <method name="requestUpdating">
            var me = this;
            $.ajax({
                url: '/api',
                data: {
                  action: "getStroingInItems",
                  flow: this.flow,
                  max:10000
                },
                success: function(data) {
                    var json = JSON.parse(data);
                    me.appendData(json);
                    return console.log("requestUpdating success:")
                },
                error: function(err) {
                  return console.warn('data error:', err);
                }
              });
        </method>

    </activelist>
    <activelist name="flowinrealtime" flow="in" bordercolor="#f0f0f0" 
        y="55" width="200" height="545" detailpanel="${this.parent.indetailpanelsleft.inrealtimedetailpanel}"></activelist>
    
    <view name="indetailpanelsleft" x="210" height="600"  layouthint='{"weight":1}'>
        <resizelayout axis="y" spacing="10"></resizelayout>
        <groupdetailpanel name="strongdetailpanel" title="strong in / low price"></groupdetailpanel>
        <groupdetailpanel name="inrealtimedetailpanel" title="strong in realtime"></groupdetailpanel>
    </view>
    <view name="indetailpanelsright" height="600"  layouthint='{"weight":1}'>
        <resizelayout axis="y" spacing="10"></resizelayout>
        <groupdetailpanel name="favourate" title="favourate"></groupdetailpanel>
        <groupdetailpanel name="outrealtime" title="strong out realtime"></groupdetailpanel>
    </view>
    <activelist name="flowoutrealtime" flow="out"
        y="55" width="200" height="545" 
        bordercolor="#f0f0f0" width="200" height="600" detailpanel="${this.parent.indetailpanelsright.outrealtime}">
    </activelist>

    <activelist name="favourate" interval="10000" x="${this.parent.flowoutrealtime.x}" 
        detailpanel="${this.parent.indetailpanelsright.favourate}"
        flow="in" bordercolor="#f0f0f0" width="200" height="50" ignorelayout="true">
        <attribute name="stocks" value="[]" type="expression"></attribute>

        <inputtext name="code" width="60" hight="16" x="2" y="20" bgcolor="#202020">
            <handler event="onkeydown" args="key">
               if (key.keyCode === 13) this.parent.updateList(this.text);
             </handler>
        </inputtext>

        <handler event="oninit">
            var str = this.getCookie("stocks");
            this.stocks = str?str.split(","):[];

            this.startBtn.setAttribute("selected", true);
        </handler>

        <method name="updateList" args="str">
            var remove = str.indexOf("-")===0;
            if (remove) str = str.substr(1);
            if (str.length>8) return;
            if (remove) {
                for (var i=0; this.stocks.length>i; i++) {
                    if (this.stocks[i] === str) break;
                }
                if (i===this.stocks.length) return;
                this.stocks.splice(i,1);
            } else {
                for (var i=0; this.stocks.length>i; i++) {
                    if (this.stocks[i] === str) return;
                }
                this.stocks.push(str);
            }
            this.code.setAttribute("text", "");
            this.saveToCookie("stocks", this.stocks.join(","));

            this.startBtn.setAttribute("selected", false);
            this.startBtn.setAttribute("selected", true);
        </method>

        <method name="saveToCookie" args="cname, value">
            document.cookie=cname+ "=" +escape(value);
        </method>

        <method name="getCookie" args="cname">
            var value = document.cookie.match(cname+'=([^\\s;]*)');
            return value?unescape(value[1]):"";
        </method>

        <method name="appendData" args="data">
            this.detailpanel.show({items:data});
        </method>

        <method name="requestUpdating">
            var me = this;
            $.ajax({
                url: '/api',
                data: {
                  action: "getFavourateItems",
                  list: this.stocks.join(",")
                },
                success: function(data) {
                    var json = JSON.parse(data);
                    me.appendData(json);
                    return                },
                error: function(err) {
                  return console.warn('data error:', err);
                }
              });
        </method>

    </activelist>
    <resizelayout axis="x" spacing="10"/>
    <handler event="oninit">
        //this.startWatching();
    </handler>
    <method name="startWatching">
        $.ajax({
            url: '/api',
            data: {
              action: "startWatching"
            },
            success: function(data) {
              return console.log("startWatching success:")
            },
            error: function(err) {
              return console.warn('data error:', err);
            }
          }).always(function(param){
            //console.log("always", param)
          });
    </method>
</view>
</body>
</html>